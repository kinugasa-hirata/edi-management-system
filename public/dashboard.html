<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDI Management System - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .user-role {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .user-role.admin {
            background: #dc2626;
            color: white;
        }

        .user-role.user {
            background: #059669;
            color: white;
        }

        .controls {
            padding: 30px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .admin-only {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .admin-only.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        .read-only-notice {
            display: none;
            background: #fef3c7;
            color: #92400e;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            margin-left: auto;
            font-size: 0.9rem;
        }

        .read-only-notice.show {
            display: block;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #4f46e5;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #4338ca;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #4b5563;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #047857;
        }

        .btn-logout {
            background: #dc2626;
            color: white;
            margin-left: auto;
        }

        .btn-logout:hover {
            background: #b91c1c;
        }

        .btn:disabled {
            background: #9ca3af !important;
            cursor: not-allowed !important;
            transform: none !important;
        }

        .content {
            padding: 30px;
        }

        .tab-navigation {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 30px;
            border-radius: 8px 8px 0 0;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s ease;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }

        .tab-btn:hover {
            color: #4f46e5;
            background: #f1f5f9;
        }

        .tab-btn.active {
            color: #4f46e5;
            background: white;
            border-bottom-color: #4f46e5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .product-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }

        .product-header h2 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .product-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .chart-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 450px;
            margin-bottom: 20px;
        }

        .chart-svg {
            width: 100%;
            height: 100%;
        }

        .chart-text {
            font-size: 12px;
            fill: #374151;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .chart-label {
            font-size: 10px;
            fill: #6b7280;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .bar-segment {
            transition: opacity 0.3s ease;
            cursor: pointer;
        }

        .bar-segment:hover {
            opacity: 0.8 !important;
        }

        .chart-axis {
            stroke: #6b7280;
            stroke-width: 1;
        }

        .no-data-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .no-future-orders {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #4f46e5;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6b7280;
            font-weight: 500;
        }

        .data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .data-header h2 {
            color: #1f2937;
            font-size: 1.5rem;
        }

        .record-count {
            color: #6b7280;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #374151;
        }

        .empty-state p {
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .steps {
            background: #f9fafb;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
            text-align: left;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .steps h4 {
            color: #374151;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .step-number {
            background: #4f46e5;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
        }

        tbody tr:hover {
            background: #f9fafb;
        }

        .status-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .status-input:disabled {
            background: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
        }

        .save-btn {
            background: #059669;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .save-btn:hover:not(:disabled) {
            background: #047857;
        }

        .save-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .message.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        #fileInput {
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .btn {
                text-align: center;
            }

            .data-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .steps {
                margin: 20px;
            }

            .user-info {
                position: static;
                margin-bottom: 15px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-info" id="userInfo">
                <span id="userDisplay">Loading...</span>
            </div>
            <h1>📊 EDI Management System</h1>
            <p>Electronic Data Interchange Order Management</p>
        </div>

        <div class="controls">
            <input type="file" id="fileInput" accept=".csv,.tsv,.EDIdat" />
            <button class="btn btn-primary admin-only" id="chooseFileBtn" onclick="document.getElementById('fileInput').click()">
                📁 Choose EDI File
            </button>
            <button class="btn btn-secondary admin-only" id="importBtn" onclick="importData()" disabled>
                📤 Import WebEDI Data
            </button>
            <button class="btn btn-success admin-only" id="saveAllBtn" onclick="saveAllChanges()">
                💾 Save All Changes
            </button>
            <div class="read-only-notice" id="readOnlyNotice">
                👁️ View-Only Mode - Contact admin for edit access
            </div>
            <button class="btn btn-logout" onclick="logout()">
                🚪 Logout
            </button>
        </div>

        <div class="content">
            <div id="messageContainer"></div>
            <div class="loading" id="loadingIndicator">
                <div class="spinner"></div>
                Loading data...
            </div>

            <!-- Always Visible Tab Navigation -->
            <div class="tab-navigation" id="tabNavigation">
                <button class="tab-btn active" onclick="showMainDashboard()">📊 All Orders</button>
                <button class="tab-btn" data-drawing="PP4166-4681P003" onclick="showProductPage('PP4166-4681P003')">🔧 4681P003</button>
                <button class="tab-btn" data-drawing="PP4166-4681P004" onclick="showProductPage('PP4166-4681P004')">🔧 4681P004</button>
                <button class="tab-btn" data-drawing="PP4166-4726P003" onclick="showProductPage('PP4166-4726P003')">⚙️ 4726P003</button>
                <button class="tab-btn" data-drawing="PP4166-4726P004" onclick="showProductPage('PP4166-4726P004')">⚙️ 4726P004</button>
                <button class="tab-btn" data-drawing="PP4166-4731P002" onclick="showProductPage('PP4166-4731P002')">🔩 4731P002</button>
                <button class="tab-btn" data-drawing="PP4166-7106P001" onclick="showProductPage('PP4166-7106P001')">🔩 7106P001</button>
                <button class="tab-btn" data-drawing="PP4166-7106P003" onclick="showProductPage('PP4166-7106P003')">🔩 7106P003</button>
            </div>

            <!-- Main Dashboard Tab -->
            <div id="mainDashboard" class="tab-content active">
                <div class="data-header">
                    <h2>EDI Orders Data</h2>
                    <span class="record-count" id="recordCount">0 records</span>
                </div>

                <div id="dataContainer">
                    <div class="empty-state">
                        <div class="icon">📊</div>
                        <h3>No EDI Data Loaded</h3>
                        <p id="emptyStateMessage">Import an EDI file to get started.</p>
                        
                        <div class="steps" id="getStartedSteps">
                            <h4>Get started in 2 simple steps:</h4>
                            <div class="step">
                                <div class="step-number">1</div>
                                <span>Click "📁 Choose EDI File" to upload your data</span>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <span>Click "Import WebEDI Data" to load orders</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Tabs Content -->
            <div id="tabContent">
                <!-- PP4166-4681P003 -->
                <div class="tab-content" id="tab-PP4166-4681P003">
                    <div class="product-header">
                        <h2>🔧 PP4166-4681P003</h2>
                        <p>ｱｯﾊﾟﾌﾚｰﾑ</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-quantity-PP4166-4681P003">0</div>
                            <div class="stat-label">Total Quantity</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-orders-PP4166-4681P003">0</div>
                            <div class="stat-label">Future Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="next-delivery-PP4166-4681P003">-</div>
                            <div class="stat-label">Next Delivery</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">📊 Delivery Schedule</div>
                        <div class="chart-wrapper" id="chart-PP4166-4681P003">
                            <div class="no-data-state" id="no-data-PP4166-4681P003">
                                <h3>📅 No Data Available</h3>
                                <p>Import EDI data to see delivery schedule for this product.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PP4166-4681P004 -->
                <div class="tab-content" id="tab-PP4166-4681P004">
                    <div class="product-header">
                        <h2>🔧 PP4166-4681P004</h2>
                        <p>ｱｯﾊﾟﾌﾚｰﾑ</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-quantity-PP4166-4681P004">0</div>
                            <div class="stat-label">Total Quantity</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-orders-PP4166-4681P004">0</div>
                            <div class="stat-label">Future Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="next-delivery-PP4166-4681P004">-</div>
                            <div class="stat-label">Next Delivery</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">📊 Delivery Schedule</div>
                        <div class="chart-wrapper" id="chart-PP4166-4681P004">
                            <div class="no-data-state" id="no-data-PP4166-4681P004">
                                <h3>📅 No Data Available</h3>
                                <p>Import EDI data to see delivery schedule for this product.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PP4166-4726P003 -->
                <div class="tab-content" id="tab-PP4166-4726P003">
                    <div class="product-header">
                        <h2>⚙️ PP4166-4726P003</h2>
                        <p>ﾄｯﾌﾟﾌﾟﾚｰﾄ</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-quantity-PP4166-4726P003">0</div>
                            <div class="stat-label">Total Quantity</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-orders-PP4166-4726P003">0</div>
                            <div class="stat-label">Future Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="next-delivery-PP4166-4726P003">-</div>
                            <div class="stat-label">Next Delivery</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">📊 Delivery Schedule</div>
                        <div class="chart-wrapper" id="chart-PP4166-4726P003">
                            <div class="no-data-state" id="no-data-PP4166-4726P003">
                                <h3>📅 No Data Available</h3>
                                <p>Import EDI data to see delivery schedule for this product.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PP4166-4726P004 -->
                <div class="tab-content" id="tab-PP4166-4726P004">
                    <div class="product-header">
                        <h2>⚙️ PP4166-4726P004</h2>
                        <p>ﾄｯﾌﾟﾌﾟﾚｰﾄ</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-quantity-PP4166-4726P004">0</div>
                            <div class="stat-label">Total Quantity</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-orders-PP4166-4726P004">0</div>
                            <div class="stat-label">Future Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="next-delivery-PP4166-4726P004">-</div>
                            <div class="stat-label">Next Delivery</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">📊 Delivery Schedule</div>
                        <div class="chart-wrapper" id="chart-PP4166-4726P004">
                            <div class="no-data-state" id="no-data-PP4166-4726P004">
                                <h3>📅 No Data Available</h3>
                                <p>Import EDI data to see delivery schedule for this product.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PP4166-4731P002 -->
                <div class="tab-content" id="tab-PP4166-4731P002">
                    <div class="product-header">
                        <h2>🔩 PP4166-4731P002</h2>
                        <p>ﾐﾄﾞﾙﾌﾚｰﾑ</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-quantity-PP4166-4731P002">0</div>
                            <div class="stat-label">Total Quantity</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-orders-PP4166-4731P002">0</div>
                            <div class="stat-label">Future Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="next-delivery-PP4166-4731P002">-</div>
                            <div class="stat-label">Next Delivery</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">📊 Delivery Schedule</div>
                        <div class="chart-wrapper" id="chart-PP4166-4731P002">
                            <div class="no-data-state" id="no-data-PP4166-4731P002">
                                <h3>📅 No Data Available</h3>
                                <p>Import EDI data to see delivery schedule for this product.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PP4166-7106P001 -->
                <div class="tab-content" id="tab-PP4166-7106P001">
                    <div class="product-header">
                        <h2>🔩 PP4166-7106P001</h2>
                        <p>ﾐﾄﾞﾙﾌﾚｰﾑ</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-quantity-PP4166-7106P001">0</div>
                            <div class="stat-label">Total Quantity</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-orders-PP4166-7106P001">0</div>
                            <div class="stat-label">Future Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="next-delivery-PP4166-7106P001">-</div>
                            <div class="stat-label">Next Delivery</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">📊 Delivery Schedule</div>
                        <div class="chart-wrapper" id="chart-PP4166-7106P001">
                            <div class="no-data-state" id="no-data-PP4166-7106P001">
                                <h3>📅 No Data Available</h3>
                                <p>Import EDI data to see delivery schedule for this product.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PP4166-7106P003 -->
                <div class="tab-content" id="tab-PP4166-7106P003">
                    <div class="product-header">
                        <h2>🔩 PP4166-7106P003</h2>
                        <p>ﾐﾄﾞﾙﾌﾚｰﾑ</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="total-quantity-PP4166-7106P003">0</div>
                            <div class="stat-label">Total Quantity</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-orders-PP4166-7106P003">0</div>
                            <div class="stat-label">Future Orders</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="next-delivery-PP4166-7106P003">-</div>
                            <div class="stat-label">Next Delivery</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">📊 Delivery Schedule</div>
                        <div class="chart-wrapper" id="chart-PP4166-7106P003">
                            <div class="no-data-state" id="no-data-PP4166-7106P003">
                                <h3>📅 No Data Available</h3>
                                <p>Import EDI data to see delivery schedule for this product.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ediData = [];
        let currentView = 'main';
        let userPermissions = { canEdit: false, canView: true };
        let currentUser = null;
        
        // Drawing numbers with product names
        const DRAWING_NUMBER_ORDER = [
            'PP4166-4681P003',
            'PP4166-4681P004', 
            'PP4166-4726P003',
            'PP4166-4726P004',
            'PP4166-4731P002',
            'PP4166-7106P001',
            'PP4166-7106P003'
        ];

        // Product names mapping (correct Japanese names)
        const PRODUCT_NAMES = {
            'PP4166-4681P003': 'ｱｯﾊﾟﾌﾞﾚｰﾑ',
            'PP4166-4681P004': 'ｱｯﾊﾟﾌﾞﾚｰﾑ',
            'PP4166-4726P003': 'ﾄｯﾌﾟﾌﾟﾚｰﾄ',
            'PP4166-4726P004': 'ﾄｯﾌﾟﾌﾟﾚｰﾄ',
            'PP4166-4731P002': 'ﾐﾄﾞﾙﾌﾚｰﾑ',
            'PP4166-7106P001': 'ﾐﾄﾞﾙﾌﾚｰﾑ',
            'PP4166-7106P003': 'ﾐﾄﾞﾙﾌﾚｰﾑ'
        };

        // Product icons mapping
        const PRODUCT_ICONS = {
            'PP4166-4681P003': '🔧',
            'PP4166-4681P004': '🔧',
            'PP4166-4726P003': '⚙️',
            'PP4166-4726P004': '⚙️',
            'PP4166-4731P002': '🔩',
            'PP4166-7106P001': '🔩',
            'PP4166-7106P003': '🔩'
        };

        // Load user info and set permissions
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user-info');
                if (response.ok) {
                    const userInfo = await response.json();
                    currentUser = userInfo;
                    userPermissions = userInfo.permissions;
                    
                    // Update UI based on permissions
                    updateUIForPermissions();
                    
                    // Update user display
                    const userDisplay = document.getElementById('userDisplay');
                    const roleClass = userInfo.role === 'admin' ? 'admin' : 'user';
                    const roleText = userInfo.role === 'admin' ? 'ADMIN' : 'VIEW ONLY';
                    userDisplay.innerHTML = `
                        ${userInfo.username}
                        <span class="user-role ${roleClass}">${roleText}</span>
                    `;
                } else {
                    // User not logged in, redirect to login
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                showMessage('Failed to load user information', 'error');
            }
        }

        // Update UI based on user permissions
        function updateUIForPermissions() {
            const adminElements = document.querySelectorAll('.admin-only');
            const readOnlyNotice = document.getElementById('readOnlyNotice');
            const emptyStateMessage = document.getElementById('emptyStateMessage');
            const getStartedSteps = document.getElementById('getStartedSteps');

            if (!userPermissions.canEdit) {
                // Disable admin elements
                adminElements.forEach(element => {
                    element.classList.add('disabled');
                    if (element.tagName === 'BUTTON') {
                        element.disabled = true;
                    }
                });
                
                // Show read-only notice
                readOnlyNotice.classList.add('show');
                
                // Update empty state message for read-only users
                if (emptyStateMessage && getStartedSteps) {
                    emptyStateMessage.textContent = 'No EDI data available. Contact admin to import data.';
                    getStartedSteps.style.display = 'none';
                }
            } else {
                // Enable admin elements
                adminElements.forEach(element => {
                    element.classList.remove('disabled');
                    if (element.tagName === 'BUTTON') {
                        element.disabled = false;
                    }
                });
                
                // Hide read-only notice
                readOnlyNotice.classList.remove('show');
            }
        }

        // Get today's date for filtering
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        // Parse date string to Date object
        function parseDate(dateString) {
            if (!dateString) return null;
            try {
                const [year, month, day] = dateString.split('/');
                return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            } catch {
                return null;
            }
        }

        // Filter orders for future dates only
        function getFutureOrders(orders) {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Start of today
            
            return orders.filter(order => {
                const orderDate = parseDate(order.delivery_date);
                return orderDate && orderDate >= today;
            });
        }

        // Enhanced group orders by delivery date and sum quantities (with individual order tracking and status)
        function groupOrdersByDate(orders) {
            const groups = {};
            
            orders.forEach(order => {
                const date = order.delivery_date;
                if (!groups[date]) {
                    groups[date] = {
                        totalQuantity: 0,
                        orders: []
                    };
                }
                groups[date].totalQuantity += parseInt(order.quantity) || 0;
                groups[date].orders.push({
                    quantity: parseInt(order.quantity) || 0,
                    orderNumber: order.order_number,
                    status: order.status || '',
                    orderId: order.id
                });
            });
            
            // Sort by date
            const sortedDates = Object.keys(groups).sort((a, b) => {
                const dateA = parseDate(a);
                const dateB = parseDate(b);
                return dateA - dateB;
            });
            
            return sortedDates.map(date => ({
                date: date,
                quantity: groups[date].totalQuantity,
                orders: groups[date].orders
            }));
        }

        // Get status color based on comment/status content
        function getStatusColor(status) {
            if (!status || status.trim() === '') {
                return '#4f46e5'; // Blue - No status
            } else if (status.toLowerCase().trim() === 'ok') {
                return '#059669'; // Green - OK status
            } else {
                return '#f59e0b'; // Yellow - Has comment but not OK
            }
        }

        // Format date to MM/DD
        function formatDateShort(dateString) {
            if (!dateString) return '';
            try {
                const [year, month, day] = dateString.split('/');
                return `${month.padStart(2, '0')}/${day.padStart(2, '0')}`;
            } catch {
                return dateString;
            }
        }

        // Enhanced create bar chart with status-based color coding and dotted lines
        function createBarChart(containerId, data, drawingNumber) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="no-data-state">
                        <h3>📅 No Future Orders</h3>
                        <p>There are no orders with delivery dates from today onwards for this product.</p>
                    </div>
                `;
                return;
            }
            
            const width = container.clientWidth - 50;
            const height = 450; // Increased height to accommodate lower labels
            const margin = { top: 20, right: 30, bottom: 80, left: 60 }; // Increased bottom margin
            
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            // Create SVG
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('class', 'chart-svg');
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            
            // Calculate scales
            const maxQuantity = Math.max(...data.map(d => d.quantity));
            const barWidth = Math.min(60, chartWidth / data.length * 0.8); // Max width of 60px
            const barSpacing = (chartWidth - (barWidth * data.length)) / (data.length + 1);
            
            // Draw Y-axis
            const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            yAxis.setAttribute('class', 'chart-axis');
            yAxis.setAttribute('x1', margin.left);
            yAxis.setAttribute('y1', margin.top);
            yAxis.setAttribute('x2', margin.left);
            yAxis.setAttribute('y2', height - margin.bottom);
            svg.appendChild(yAxis);
            
            // Draw X-axis
            const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            xAxis.setAttribute('class', 'chart-axis');
            xAxis.setAttribute('x1', margin.left);
            xAxis.setAttribute('y1', height - margin.bottom);
            xAxis.setAttribute('x2', width - margin.right);
            xAxis.setAttribute('y2', height - margin.bottom);
            svg.appendChild(xAxis);
            
            // Draw bars with status-based coloring, labels, and dotted lines
            data.forEach((d, i) => {
                const totalBarHeight = (d.quantity / maxQuantity) * chartHeight;
                const x = margin.left + barSpacing + (i * (barWidth + barSpacing));
                const barBottom = height - margin.bottom;
                
                // Draw multi-colored bar segments based on order status
                let cumulativeHeight = 0;
                d.orders.forEach((order, orderIndex) => {
                    const segmentHeight = (order.quantity / d.quantity) * totalBarHeight;
                    const segmentY = barBottom - cumulativeHeight - segmentHeight;
                    const statusColor = getStatusColor(order.status);
                    
                    // Create colored bar segment
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', x);
                    rect.setAttribute('y', segmentY);
                    rect.setAttribute('width', barWidth);
                    rect.setAttribute('height', segmentHeight);
                    rect.setAttribute('fill', statusColor);
                    rect.setAttribute('stroke', '#ffffff');
                    rect.setAttribute('stroke-width', '0.5');
                    rect.setAttribute('class', 'bar-segment');
                    
                    // Enhanced tooltip with status information
                    const statusText = order.status ? ` (Status: "${order.status}")` : ' (No status)';
                    const tooltipText = `${formatDateShort(d.date)} - ${order.orderNumber}\nQuantity: ${order.quantity}${statusText}`;
                    rect.setAttribute('title', tooltipText);
                    
                    // Add hover effect
                    rect.addEventListener('mouseenter', function() {
                        this.setAttribute('opacity', '0.8');
                    });
                    rect.addEventListener('mouseleave', function() {
                        this.setAttribute('opacity', '1');
                    });
                    
                    svg.appendChild(rect);
                    
                    // Add dotted separator line between segments (except before first segment)
                    if (orderIndex > 0) {
                        const lineY = barBottom - cumulativeHeight;
                        const dottedLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        dottedLine.setAttribute('x1', x);
                        dottedLine.setAttribute('y1', lineY);
                        dottedLine.setAttribute('x2', x + barWidth);
                        dottedLine.setAttribute('y2', lineY);
                        dottedLine.setAttribute('stroke', 'white');
                        dottedLine.setAttribute('stroke-width', '2');
                        dottedLine.setAttribute('stroke-dasharray', '4,2');
                        dottedLine.setAttribute('opacity', '0.9');
                        svg.appendChild(dottedLine);
                    }
                    
                    cumulativeHeight += segmentHeight;
                });
                
                // Add quantity label on top of bar
                const quantityText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                quantityText.setAttribute('class', 'chart-text');
                quantityText.setAttribute('x', x + barWidth / 2);
                quantityText.setAttribute('y', barBottom - totalBarHeight - 5);
                quantityText.setAttribute('text-anchor', 'middle');
                quantityText.setAttribute('font-weight', 'bold');
                quantityText.setAttribute('font-size', '12');
                quantityText.setAttribute('fill', '#1f2937');
                quantityText.textContent = d.quantity;
                svg.appendChild(quantityText);
                
                // Add order count label if multiple orders
                if (d.orders.length > 1) {
                    const countText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    countText.setAttribute('class', 'chart-text');
                    countText.setAttribute('x', x + barWidth / 2);
                    countText.setAttribute('y', barBottom - totalBarHeight - 20);
                    countText.setAttribute('text-anchor', 'middle');
                    countText.setAttribute('font-size', '10');
                    countText.setAttribute('fill', '#6b7280');
                    countText.textContent = `(${d.orders.length} orders)`;
                    svg.appendChild(countText);
                }
                
                // Add date label below X-axis (moved lower)
                const dateText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                dateText.setAttribute('class', 'chart-label');
                dateText.setAttribute('x', x + barWidth / 2);
                dateText.setAttribute('y', height - margin.bottom + 25);
                dateText.setAttribute('text-anchor', 'middle');
                dateText.setAttribute('font-size', '11');
                dateText.setAttribute('font-weight', '500');
                dateText.textContent = formatDateShort(d.date);
                svg.appendChild(dateText);
                
                // Add full date on second line for clarity
                const fullDateText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                fullDateText.setAttribute('class', 'chart-label');
                fullDateText.setAttribute('x', x + barWidth / 2);
                fullDateText.setAttribute('y', height - margin.bottom + 40);
                fullDateText.setAttribute('text-anchor', 'middle');
                fullDateText.setAttribute('font-size', '9');
                fullDateText.setAttribute('fill', '#9ca3af');
                fullDateText.textContent = d.date.split('/')[0]; // Just the year
                svg.appendChild(fullDateText);
            });
            
            // Add Y-axis labels and grid lines
            const yLabelCount = 6;
            for (let i = 0; i <= yLabelCount; i++) {
                const value = Math.round((maxQuantity / yLabelCount) * i);
                const y = height - margin.bottom - (chartHeight / yLabelCount) * i;
                
                // Y-axis label
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('class', 'chart-text');
                label.setAttribute('x', margin.left - 10);
                label.setAttribute('y', y + 3);
                label.setAttribute('text-anchor', 'end');
                label.setAttribute('font-size', '11');
                label.textContent = value;
                svg.appendChild(label);
                
                // Grid line
                if (i > 0) {
                    const gridLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    gridLine.setAttribute('x1', margin.left);
                    gridLine.setAttribute('y1', y);
                    gridLine.setAttribute('x2', width - margin.right);
                    gridLine.setAttribute('y2', y);
                    gridLine.setAttribute('stroke', '#f3f4f6');
                    gridLine.setAttribute('stroke-width', '1');
                    svg.appendChild(gridLine);
                }
            }
            
            // Add status legend
            const legendY = margin.top;
            const legendItems = [
                { color: '#4f46e5', label: 'No Status' },
                { color: '#f59e0b', label: 'Has Comment' },
                { color: '#059669', label: 'OK Status' }
            ];
            
            legendItems.forEach((item, index) => {
                const legendX = width - margin.right - 120 + (index * 40);
                
                // Legend color box
                const legendRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                legendRect.setAttribute('x', legendX);
                legendRect.setAttribute('y', legendY);
                legendRect.setAttribute('width', '12');
                legendRect.setAttribute('height', '12');
                legendRect.setAttribute('fill', item.color);
                legendRect.setAttribute('stroke', '#ffffff');
                legendRect.setAttribute('stroke-width', '1');
                svg.appendChild(legendRect);
                
                // Legend text
                const legendText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                legendText.setAttribute('x', legendX + 16);
                legendText.setAttribute('y', legendY + 9);
                legendText.setAttribute('font-size', '8');
                legendText.setAttribute('fill', '#6b7280');
                legendText.textContent = item.label;
                svg.appendChild(legendText);
            });
            
            // Add enhanced chart title at the bottom
            const titleText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            titleText.setAttribute('x', width / 2);
            titleText.setAttribute('y', height - 5);
            titleText.setAttribute('text-anchor', 'middle');
            titleText.setAttribute('font-size', '10');
            titleText.setAttribute('fill', '#6b7280');
            titleText.textContent = 'Delivery dates (MM/DD) with status-colored segments: Blue=No Status, Yellow=Comment, Green=OK';
            svg.appendChild(titleText);
            
            container.innerHTML = '';
            container.appendChild(svg);
        }

        // Show main dashboard
        function showMainDashboard() {
            currentView = 'main';
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Show main dashboard
            document.getElementById('mainDashboard').classList.add('active');
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.tab-btn').classList.add('active');
        }

        // Show product page
        function showProductPage(drawingNumber) {
            currentView = drawingNumber;
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Show specific tab content
            document.getElementById(`tab-${drawingNumber}`).classList.add('active');
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-drawing="${drawingNumber}"]`).classList.add('active');
            
            // Generate chart for this product
            generateProductChart(drawingNumber);
        }

        // Generate product chart
        function generateProductChart(drawingNumber) {
            const productOrders = ediData.filter(order => order.drawing_number === drawingNumber);
            const futureOrders = getFutureOrders(productOrders);
            const chartData = groupOrdersByDate(futureOrders);
            
            createBarChart(`chart-${drawingNumber}`, chartData, drawingNumber);
            
            // Update stats
            const totalQuantity = futureOrders.reduce((sum, order) => sum + (parseInt(order.quantity) || 0), 0);
            const totalOrders = futureOrders.length;
            const nextDelivery = futureOrders.length > 0 ? futureOrders[0].delivery_date : 'None';
            
            document.getElementById(`total-quantity-${drawingNumber}`).textContent = totalQuantity;
            document.getElementById(`total-orders-${drawingNumber}`).textContent = totalOrders;
            document.getElementById(`next-delivery-${drawingNumber}`).textContent = nextDelivery;
        }

        // Update all product charts when data changes
        function updateAllProductCharts() {
            DRAWING_NUMBER_ORDER.forEach(drawingNumber => {
                generateProductChart(drawingNumber);
            });
        }

        // File input handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const importBtn = document.getElementById('importBtn');
            
            if (file && userPermissions.canEdit) {
                importBtn.disabled = false;
                importBtn.textContent = `📤 Import ${file.name}`;
                showMessage(`File selected: ${file.name}`, 'success');
            } else {
                importBtn.disabled = true;
                importBtn.textContent = '📤 Import WebEDI Data';
            }
        });

        async function importData() {
            if (!userPermissions.canEdit) {
                showMessage('You do not have permission to import data', 'error');
                return;
            }

            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('Please select a file first', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('ediFile', file);

            try {
                showLoading(true);
                
                const response = await fetch('/api/import-edi', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(result.message, 'success');
                    await loadData(); // Reload data after import
                    
                    // Reset file input
                    fileInput.value = '';
                    document.getElementById('importBtn').disabled = true;
                    document.getElementById('importBtn').textContent = '📤 Import WebEDI Data';
                } else {
                    showMessage(result.error || 'Import failed', 'error');
                }
            } catch (error) {
                if (error.message.includes('403')) {
                    showMessage('You do not have permission to import data', 'error');
                } else {
                    showMessage('Import failed: ' + error.message, 'error');
                }
            } finally {
                showLoading(false);
            }
        }

        async function loadData() {
            try {
                showLoading(true);
                
                const response = await fetch('/api/edi-data');
                
                if (response.status === 401) {
                    showMessage('Session expired. Please log in again.', 'error');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                ediData = data;
                renderTable();
                
                // Update all product charts when data is loaded
                updateAllProductCharts();
                
            } catch (error) {
                showMessage('Failed to load data: ' + error.message, 'error');
                console.error('Error loading data:', error);
            } finally {
                showLoading(false);
            }
        }

        function renderTable() {
            const container = document.getElementById('dataContainer');
            const recordCount = document.getElementById('recordCount');
            
            recordCount.textContent = `${ediData.length} records`;

            if (ediData.length === 0) {
                const emptyMessage = userPermissions.canEdit ? 
                    'Import an EDI file to get started.' : 
                    'No EDI data available. Contact admin to import data.';
                
                const steps = userPermissions.canEdit ? `
                    <div class="steps">
                        <h4>Get started in 2 simple steps:</h4>
                        <div class="step">
                            <div class="step-number">1</div>
                            <span>Click "📁 Choose EDI File" to upload your data</span>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <span>Click "Import WebEDI Data" to load orders</span>
                        </div>
                    </div>
                ` : '';

                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📊</div>
                        <h3>No EDI Data Loaded</h3>
                        <p>${emptyMessage}</p>
                        ${steps}
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>注文番号<br><small>Order Number</small></th>
                                <th>図番<br><small>Drawing Number</small></th>
                                <th>品名<br><small>Product Name</small></th>
                                <th>注文数量<br><small>Quantity</small></th>
                                <th>納期<br><small>Delivery Date</small></th>
                                <th>Status<br><small>Comments</small></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ediData.map(order => `
                                <tr>
                                    <td><strong>${order.order_number || ''}</strong></td>
                                    <td><strong>${order.drawing_number || ''}</strong></td>
                                    <td>${order.product_name || ''}</td>
                                    <td>${order.quantity || ''}</td>
                                    <td>${order.delivery_date || ''}</td>
                                    <td>
                                        <input type="text" class="status-input" 
                                               value="${order.status || ''}" 
                                               data-order-id="${order.id}"
                                               placeholder="${userPermissions.canEdit ? 'Add comments...' : 'Read only'}"
                                               ${!userPermissions.canEdit ? 'disabled' : ''}>
                                        ${userPermissions.canEdit ? `<button class="save-btn" onclick="saveStatus(${order.id})">Save</button>` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = tableHTML;
        }

        async function saveStatus(orderId) {
            if (!userPermissions.canEdit) {
                showMessage('You do not have permission to save changes', 'error');
                return;
            }

            const input = document.querySelector(`[data-order-id="${orderId}"]`);
            const status = input.value;

            try {
                const response = await fetch(`/api/edi-data/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage('Status updated successfully', 'success');
                    
                    // Update local data
                    const order = ediData.find(o => o.id == orderId);
                    if (order) {
                        order.status = status;
                    }
                    
                    // Update all product charts to reflect new status colors
                    updateAllProductCharts();
                    
                } else {
                    showMessage(result.error || 'Failed to update status', 'error');
                }
            } catch (error) {
                if (error.message.includes('403')) {
                    showMessage('You do not have permission to save changes', 'error');
                } else {
                    showMessage('Failed to save status: ' + error.message, 'error');
                }
            }
        }

        async function saveAllChanges() {
            if (!userPermissions.canEdit) {
                showMessage('You do not have permission to save changes', 'error');
                return;
            }

            const inputs = document.querySelectorAll('.status-input:not(:disabled)');
            let updated = 0;
            let errors = 0;

            showLoading(true);

            for (const input of inputs) {
                const orderId = input.getAttribute('data-order-id');
                const status = input.value;

                try {
                    const response = await fetch(`/api/edi-data/${orderId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status })
                    });

                    if (response.ok) {
                        updated++;
                        // Update local data
                        const order = ediData.find(o => o.id == orderId);
                        if (order) {
                            order.status = status;
                        }
                    } else {
                        errors++;
                    }
                } catch (error) {
                    errors++;
                }
            }

            showLoading(false);
            
            if (errors === 0) {
                showMessage(`All ${updated} changes saved successfully`, 'success');
            } else {
                showMessage(`${updated} saved, ${errors} errors occurred`, 'error');
            }
            
            // Update all product charts to reflect new status colors
            updateAllProductCharts();
        }

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            container.appendChild(messageDiv);
            
            // Remove message after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        function showLoading(show) {
            const loading = document.getElementById('loadingIndicator');
            loading.style.display = show ? 'block' : 'none';
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/';
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await loadUserInfo();
            await loadData();
        });

        // Auto-refresh data every 5 minutes
        setInterval(() => {
            loadData();
        }, 300000);
    </script>
</body>
</html>